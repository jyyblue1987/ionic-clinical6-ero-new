{"version":3,"sources":["../src/@ionic-clinical6/core/flow_process/flow_steps/flowstep-signature/flowstep-signature.ts"],"names":[],"mappings":"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","file":"flowstep-signature.js","sourcesContent":["/* globals Clinical6 */\nimport { Component, ViewChild, ElementRef, Renderer } from '@angular/core';\nimport { Modal, NavController, NavParams, ModalController, Loading, LoadingController, AlertController, Alert, Platform } from 'ionic-angular';\nimport { Clinical6Service } from '../../../clinical6.service';\nimport { HelpModalPage } from '../../../modal/help-modal';\nimport { FlowStepPage } from '../flowstep';\nimport { SafeResourceUrl, DomSanitizer } from '@angular/platform-browser';\nimport { FlowService } from '../../flow.service';\nimport { clinical6, agreementService, Profile } from 'clinical6';\n\nimport { ThemeableBrowser, ThemeableBrowserObject } from '@ionic-native/themeable-browser';\nimport { UtilsService } from '../../../utils.service';\n\nconst STATUS_SIGNED: string = 'SIGNED';\n\n@Component({\n  selector: 'flowstep-signature',\n  templateUrl: 'flowstep-signature.html'\n})\n\nexport class FlowStepSignPage extends FlowStepPage {\n\n  baseUrl: string = clinical6.apiBaseUrl;\n  signatureUrl: string;\n  redirectUrl: string;\n  showHelpButton: boolean;\n  browser: ThemeableBrowserObject;\n  // browserObject: ThemeableBrowserObject;\n  alertView: Alert;\n  signatureStatus: string;\n  goback: boolean;\n  viewLeft: boolean;\n\n  retries: number = 0;\n  pinCode: string;\n  options: object;\n\n  errorTitle: string = 'Unable to retrieve signature document';\n  errorMissingData: string = 'Missing required information';\n  errorAlreadySigned: string = 'Your document has been already signed.';\n  errorOkButton: string = 'OK';\n  \n  constructor(\n    public navParams: NavParams,\n    public nav: NavController,\n    public flowCtlr: FlowService,\n    public utilsSvc: UtilsService,\n    public _alertCtrl: AlertController,\n    public modalCtrl: ModalController,\n    public sanitizer: DomSanitizer,\n    public elementRef: ElementRef,\n    public renderer: Renderer,\n    public platform: Platform) {\n\n    super(utilsSvc, navParams, nav, flowCtlr, modalCtrl, sanitizer);\n\n    this.createAlert();\n\n    this.showHelpButton = this.step.help_subtitle || this.step.help_text;\n    this.goback = true;\n\n    this.themeColor = '#4f2683';\n  }\n\n  ionViewDidLoad() {\n    // console.log('Signature: viewDidLoad()');\n\n    // retrieve profile\n    clinical6.getProfile()\n      .then(profile => { this.requestSignature(profile); })\n      .catch(reason => {\n        console.log(reason);\n      });\n  }\n\n  ionViewDidEnter() {\n    // console.log('Signature: ionViewDidEnter()');\n\n    if (this.viewLeft && this.signatureStatus === STATUS_SIGNED) {\n      if (!this.alertView) {\n        this.createAlert();\n      }\n      this.alertView.present();\n    } else if (this.viewLeft) {\n      this.launchUrl(this.signatureUrl);\n    }\n    this.viewLeft = false;\n  }\n\n  ionViewWillLeave() {\n    // console.log('Signature: ionViewWillLeave()');\n    if (this.alertView) {\n      this.alertView.dismiss();\n      this.alertView = undefined;\n    }\n    this.viewLeft = true;\n  }\n\n  createAlert() {\n    // console.log('Signature: createAlert()');\n    this.alertView = this._alertCtrl.create({\n      message: this.errorAlreadySigned,\n      enableBackdropDismiss: false,\n      buttons: [{\n        text: this.errorOkButton,\n        handler: data => this.gotoNext(this)\n      }]\n    });\n  }\n\n  requestSignature(profile: Profile) {\n    // console.log('Signature: requestSignature()');\n\n    var thisRef = this;\n\n    let userEmail = profile.email;\n    let recipients = [\n      { email: userEmail, role: 'SIGNER', 'signing_order': 1 }\n    ];\n    if (this.pinCode) recipients[0]['signing_password'] = this.pinCode;\n\n    if (this.step.agreement_template_id && userEmail) {\n      let options = this.setupOptions();\n      agreementService.get(this.step.agreement_template_id, recipients, options)\n        .then(response => thisRef.handleSignatureResponse(thisRef, response))\n        .catch(reason => {\n          console.log(reason);\n          if (this.retries--) {\n            this.requestSignature(profile);\n          }\n          else {\n            let alert = this._alertCtrl.create ({\n              title: this.errorTitle,\n              message: reason.message,\n              cssClass: 'alert',\n              buttons: [\n                {\n                    text: this.errorOkButton,\n                    handler: () => {\n                      this.goBack();\n                    }\n                }\n              ]\n            });\n            alert.present();\n          }\n        });\n    } else {\n      let alert = this._alertCtrl.create ({\n        title: this.errorTitle,\n        message: this.errorMissingData,\n        cssClass: 'alert',\n        buttons: [\n          {\n              text: this.errorOkButton,\n              handler: () => {\n                this.goBack();\n              }\n          }\n        ]\n      });\n      alert.present();\n\n      // this.goBack();\n    }\n  }\n\n  handleSignatureResponse(ref: any, response: any) {\n    ref.signatureUrl = response.signatures[0].signUrl;\n    if (response.template && response.template.redirectUrl) // TODO is this API correct\n       ref.redirectUrl = response.template.redirectUrl;\n    else\n      ref.redirectUrl = response.signatures[0].redirectUrl;\n    ref.signatureStatus = response.status;\n\n    // todo check the document status\n    if (ref.signatureStatus === STATUS_SIGNED) {\n      ref.alertView.present();\n    } else {\n      ref.launchUrl(ref.signatureUrl);\n    }\n  }\n\n\n  setupOptions() {\n    var options: any = {};\n\n    if (this.step.flow_process_id) {\n      options.flow_process_id = this.step.flow_process_id;\n    }\n    return options;\n  }\n\n  launchUrl(url: string) {\n\n    console.log('Signature: launchUrl(): ', url);\n    var thisRef = this;\n\n    var target = '_blank';\n\n    var optionsiOS = this.options || {\n      statusbar: {\n        color: this.themeColor\n        // color: '#4f2683'\n      },\n      toolbar: {\n        height: 44,\n        color: this.themeColor\n        // color: '#4f2683'\n      },\n      title: {\n        color: '#ffffffff',\n        staticText: ''\n      },\n      backButton: {\n        wwwImage: 'assets/images/back_arrow100x100+15.png',\n        wwwImageDensity: 4,\n        align: 'left',\n        event: 'backPressed'\n      },\n      closeButton: {\n        image: 'close',\n        imagePressed: 'close_pressed',\n        align: 'left',\n        event: 'closePressed'\n      },\n      backButtonCanClose: true\n    };\n\n    var optionsAndroid = this.options || {\n      statusbar: {\n        color: this.themeColor\n        // color: '#4f2683'\n      },\n      toolbar: {\n        height: 44,\n        color: this.themeColor\n        // color: '#4f2683'\n      },\n      title: {\n        color: '#ffffffff',\n        staticText: ''\n      },\n      backButton: {\n        wwwImage: 'assets/images/back_arrow100x100+15.png',\n        wwwImageDensity: 4,\n        align: 'left',\n        event: 'backPressed'\n      },\n      backButtonCanClose: true\n    };\n\n    if (this.platform.is('android')) {\n      this.browser = new ThemeableBrowserObject(url, target, optionsAndroid);\n    } else {\n      this.browser = new ThemeableBrowserObject(url, target, optionsiOS);\n    }\n\n    this.browser.on('loadstart').subscribe(\n      res => thisRef.loadStart(res, thisRef),\n      error => console.log('InAppBrowser loadstart Event Error: ' + error)\n    );\n\n    this.browser.on('loadstop').subscribe(\n      res => {\n        thisRef.loadStop(res);\n      },\n      error => console.log('InAppBrowser loadstop Event Error: ' + error)\n    );\n\n    this.browser.on('loaderror').subscribe(\n      res => thisRef.loadError(res),\n      error => console.log('InAppBrowser loaderror Event Error: ' + error)\n    );\n\n    this.browser.on('exit').subscribe(\n      res => thisRef.exit(res, thisRef),\n      error => console.log('InAppBrowser exit Event Error: ' + error)\n    );\n\n    this.browser.on('closePressed').subscribe(\n      res => thisRef.closePressed(thisRef),\n      error => console.log('InAppBrowser exit Event Error: ' + error)\n    );\n\n    this.browser.on('backPressed').subscribe(\n      res => thisRef.backPressed(thisRef),\n      error => console.log('InAppBrowser exit Event Error: ' + error)\n    );\n  }\n\n  loadStart(resource: any, ref: any) {\n    // check redirect\n    // console.log('FlowStepSignPage, loadStart', resource);\n    if (ref.redirectUrl === resource.url.replace(/\\/$/, '')) {\n      this.signatureStatus = STATUS_SIGNED;\n\n      ref.gotoNext(ref);\n      ref.goback = false;\n      setTimeout(() => ref.browser.close(), 200);\n    }\n  }\n\n  loadStop(resource: any) {\n    // Add code to be injected here\n    console.warn('FlowStepSignPage, loadStop', resource);\n    let code = ` `;\n    this.browser.executeScript({ code: code });\n  }\n\n  loadError(resource: any) {\n    console.warn('FlowStepSignPage, loadError', resource);\n  }\n\n  exit(resource: any, ref: any) {\n    // console.log('InAppBrowser exit Event ' + resource);\n    if (ref.goback) {\n      ref.goBack();\n    }\n  }\n\n  closePressed(ref: any) {\n    // console.log('FlowStepSignPage, closePressed');\n    setTimeout(() => ref.browser.close(), 200);\n  }\n\n  backPressed(ref: any) {\n    // console.log('FlowStepSignPage, backPressed');\n  }\n\n  gotoNext(ref: any) {\n    let stepName = ref.step.paths[0].button_name;\n    // console.log('FlowStepSignPage, gotoNext');\n    ref.gotoFlow(stepName);\n  }\n\n  goBack() {\n    // console.log('FlowStepSignPage, goBack');\n    this.nav.pop();\n  }\n}"]}